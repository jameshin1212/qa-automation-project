version: '3.8'

services:
  # Mock ì„œë²„ (ë…ë¦½ ì‹¤í–‰)
  qa-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: whatap-qa-server
    environment:
      - PYTHONUNBUFFERED=1
    ports:
      - "3000:3000"  # Mock server port
    command: >
      bash -c "
        echo 'ğŸš€ Starting Mock Server...' &&
        cd mock_server && npm start"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/config"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
  
  # API í…ŒìŠ¤íŠ¸ ì „ìš©
  api-test:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: whatap-api-test
    environment:
      - PYTHONUNBUFFERED=1
      - API_BASE_URL=http://qa-server:3000
    volumes:
      - ./allure-results:/app/allure-results
      - ./reports:/app/reports
    depends_on:
      qa-server:
        condition: service_healthy
    command: >
      bash -c "
        echo 'ğŸ§ª Running API Tests...' &&
        echo '================================' &&
        pytest tests/api -v --alluredir=allure-results &&
        echo '================================' &&
        echo 'âœ… API Tests Completed!' &&
        echo 'Total: 25 API test cases executed'"
    networks:
      - default

  # UI í…ŒìŠ¤íŠ¸ ì „ìš©
  ui-test:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: whatap-ui-test
    environment:
      - PYTHONUNBUFFERED=1
      - API_BASE_URL=http://qa-server:3000
    volumes:
      - ./allure-results:/app/allure-results
      - ./reports:/app/reports
    depends_on:
      qa-server:
        condition: service_healthy
    command: >
      bash -c "
        echo 'ğŸ–¥ï¸ Running UI Tests...' &&
        echo '================================' &&
        pytest tests/ui -v --alluredir=allure-results &&
        echo '================================' &&
        echo 'âœ… UI Tests Completed!' &&
        echo 'Total: 6 UI test cases executed'"
    networks:
      - default

  # ì „ì²´ í…ŒìŠ¤íŠ¸ (API + UI)
  all-test:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: whatap-all-test
    environment:
      - PYTHONUNBUFFERED=1
      - API_BASE_URL=http://qa-server:3000
    volumes:
      - ./allure-results:/app/allure-results
      - ./reports:/app/reports
    depends_on:
      qa-server:
        condition: service_healthy
    command: >
      bash -c "
        echo 'ğŸ§ª Running All Tests (API + UI)...' &&
        echo '================================' &&
        pytest -v --alluredir=allure-results &&
        echo '================================' &&
        echo 'âœ… All Tests Completed!' &&
        echo 'Total: 31 test cases (25 API + 6 UI) executed'"
    networks:
      - default

  # Allure Report ì„œë²„
  allure-report:
    image: frankescobar/allure-docker-service:latest
    container_name: whatap-allure-report
    ports:
      - "5050:5050"
    volumes:
      - ./allure-results:/app/default-results
      - ./allure-report:/app/default-reports
    environment:
      CHECK_RESULTS_EVERY_SECONDS: 3
      KEEP_HISTORY: "TRUE"
    command: >
      bash -c "
        echo 'ğŸ“Š Starting Allure Report Server...' &&
        echo '================================' &&
        echo 'ğŸŒ Access report at: http://localhost:5050' &&
        echo '================================' &&
        /app/runAllureServer.sh"

  # ê°œë³„ Mock ì„œë²„ (í•„ìš”ì‹œ ì‚¬ìš©)
  mock-server:
    build:
      context: .
      dockerfile: Dockerfile.mock
    container_name: whatap-mock-server
    ports:
      - "3001:3000"
    volumes:
      - ./mock_server:/app
      - /app/node_modules
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/config"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    profiles:
      - dev

  # ê°œë³„ í…ŒìŠ¤íŠ¸ ëŸ¬ë„ˆ (í•„ìš”ì‹œ ì‚¬ìš©)
  test-runner:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: whatap-test-runner
    environment:
      - API_BASE_URL=http://mock-server:3000
      - PYTHONUNBUFFERED=1
    volumes:
      - ./tests:/app/tests:ro
      - ./allure-results:/app/allure-results
      - ./reports:/app/reports
    depends_on:
      mock-server:
        condition: service_healthy
    command: pytest -v
    profiles:
      - dev

networks:
  default:
    name: qa-network