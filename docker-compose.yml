version: '3.8'

services:
  # í†µí•© í…ŒìŠ¤íŠ¸ í™˜ê²½ (Mock ì„œë²„ + í…ŒìŠ¤íŠ¸ ëŸ¬ë„ˆ)
  qa-test:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: whatap-qa-test
    environment:
      - PYTHONUNBUFFERED=1
      - API_BASE_URL=http://localhost:3000
    volumes:
      - ./allure-results:/app/allure-results
      - ./allure-report:/app/allure-report
      - ./reports:/app/reports
    ports:
      - "3000:3000"  # Mock server port
      - "5050:5050"  # Allure report port (optional)
    command: >
      bash -c "
        echo 'ðŸš€ Starting WhaTap QA Automation Tests...' &&
        cd mock_server && npm start &
        echo 'â³ Waiting for mock server to be ready...' &&
        sleep 5 &&
        for i in {1..30}; do
          curl -s http://localhost:3000/config > /dev/null 2>&1 && break || echo 'Waiting for server... ('$$i'/30)' && sleep 1;
        done &&
        echo 'âœ… Mock server is ready!' &&
        echo 'ðŸ§ª Running tests...' &&
        pytest -v &&
        echo 'âœ… Tests completed!' &&
        if [ -d allure-results ] && [ \"$(ls -A allure-results)\" ]; then
          echo 'ðŸ“Š Generating Allure report...' &&
          allure generate allure-results -o allure-report --clean &&
          echo 'ðŸ“Š Allure report generated at /app/allure-report';
        fi &&
        echo 'ðŸŽ‰ All tasks completed successfully!'
      "

  # ê°œë³„ Mock ì„œë²„ (í•„ìš”ì‹œ ì‚¬ìš©)
  mock-server:
    build:
      context: .
      dockerfile: Dockerfile.mock
    container_name: whatap-mock-server
    ports:
      - "3001:3000"
    volumes:
      - ./mock_server:/app
      - /app/node_modules
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/config"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    profiles:
      - dev

  # ê°œë³„ í…ŒìŠ¤íŠ¸ ëŸ¬ë„ˆ (í•„ìš”ì‹œ ì‚¬ìš©)
  test-runner:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: whatap-test-runner
    environment:
      - API_BASE_URL=http://mock-server:3000
      - PYTHONUNBUFFERED=1
    volumes:
      - ./tests:/app/tests:ro
      - ./allure-results:/app/allure-results
      - ./reports:/app/reports
    depends_on:
      mock-server:
        condition: service_healthy
    command: pytest -v
    profiles:
      - dev

networks:
  default:
    name: qa-network